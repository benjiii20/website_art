<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Favorite Artists</title>

  <!-- Fonts: match Search page (Inter + Cormorant Garamond) -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Cormorant+Garamond:wght@400;500;600&display=swap" rel="stylesheet">

  <!-- Shared theme + palette -->
  <link rel="stylesheet" href="../search_page/search_styles.css" />

  <style>
    /* ✅ IMPORTANT: do NOT override body background here
       (search_styles.css already sets the noir/beige gradients) */

    /* Header layout (reuse search styling, add actions on the right) */
    .favorites-head{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:16px;
      margin-bottom: 18px;
    }
    .favorites-actions{
      display:flex;
      gap:10px;
      align-items:center;
    }

    /* Clear button — matches palette */
    .fav-clear{
      padding:10px 14px;
      border-radius:999px;
      border:1px solid var(--line);
      background:var(--chip);
      color: var(--muted);
      font-size:.92rem;
      cursor:pointer;
      box-shadow: var(--shadow-soft);
      transition: filter .15s ease, transform .02s ease, border-color .18s ease;
    }
    .fav-clear:hover{ filter:brightness(1.06); border-color: var(--gold-line); }
    .fav-clear:active{ transform:translateY(1px); }
    .fav-clear:disabled{ opacity:.5; cursor:default; }

    /* Compact grid on favorites page */
    .favorites-compact{ grid-template-columns:repeat(auto-fill,minmax(200px,1fr)); }
    .favorites-compact .artist-card{ max-width:260px; margin:0 auto; }
    .favorites-compact .artist-info h3{ font-size:1rem; }

    /* ✅ Remove button BACK on artwork (top-right) and GOLD */
    .fav-btn{
      position:absolute;
      top:10px;
      right:10px;
      width:32px;
      height:32px;
      display:grid;
      place-items:center;

      border-radius:999px;
      border: 1px solid var(--gold-line);
      background: rgba(0,0,0,.28);
      color: var(--gold);          /* ✅ gold */
      cursor:pointer;
      font-size:1.15rem;
      line-height:1;
      backdrop-filter: blur(2px);
      box-shadow: 0 12px 26px rgba(0,0,0,.35);

      transition: filter .15s ease, transform .1s ease, border-color .15s ease;
      z-index: 5; /* ensure above image */
    }
    .fav-btn:hover{
      filter: brightness(1.06);
      border-color: rgba(242,195,74,.35);
    }
    .fav-btn:active{ transform: translateY(1px); }

    /* light mode: still gold, softer overlay */
    body[data-theme="light"] .fav-btn{
      background: rgba(255,255,255,.55);
      color: var(--gold);
      border-color: var(--gold-line);
      box-shadow: 0 12px 22px rgba(20,21,26,.10);
    }
  </style>

  <script>
    window.SUPABASE_URL = 'https://jhzlxmomyypgtkuwdvzn.supabase.co';
    window.SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impoemx4bW9teXlwZ3RrdXdkdnpuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgzOTgzMzEsImV4cCI6MjA3Mzk3NDMzMX0.IZw6mlxn7Hbue5UlrckhPJeCDNplj-zM1zoiddQGnj0';
  </script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>
  <div class="search-container">

    <!-- Header matches Search page + logo in the same spot -->
    <header class="favorites-head">
      <div>
        <h1 class="page-title">
          <img
            src="../logos/KH gold.png"
            alt="Khaya"
            class="brand-logo"
            decoding="async"
            loading="eager"
          />
        </h1>
        <p class="page-subtitle muted">Your saved artists.</p>
      </div>

      <div class="favorites-actions">
        <button
          class="icon-button"
          type="button"
          data-theme-toggle
          aria-label="Toggle theme"
          title="Toggle theme"
        >☀</button>

        <a class="icon-button" href="../search_page/search_bar.html" aria-label="Back to search" title="Back to search">⌂</a>

        <button id="favClear" class="fav-clear" type="button">Clear all</button>
      </div>
    </header>

    <div id="favStatus" class="muted" aria-live="polite" style="margin:12px 0;"></div>
    <div id="favGrid" class="results-grid favorites-compact"></div>
  </div>

  <script defer src="../theme-toggle.js"></script>
  <script>
    (async function() {
      const supa = window.supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);
      const grid = document.getElementById("favGrid");
      const status = document.getElementById("favStatus");
      const clearBtn = document.getElementById("favClear");

      const FAVORITES_KEY = "favorite_artists";

      let userId = null;
      let mode = "local"; // "account" (Supabase) or "local" (localStorage)

      function loadFavoritesLocal() {
        try { return JSON.parse(localStorage.getItem(FAVORITES_KEY)) || []; }
        catch { return []; }
      }
      function saveFavoritesLocal(list) {
        localStorage.setItem(FAVORITES_KEY, JSON.stringify(list));
      }

      async function detectSessionUser() {
        try {
          const { data: { session } } = await supa.auth.getSession();
          return session?.user?.id || null;
        } catch {
          return null;
        }
      }

      async function loadFavorites() {
        if (mode === "account" && userId) {
          const { data, error } = await supa
            .from("favorites")
            .select("artist_id, created_at, artist:artists(id,name,slug,country,region_sub)")
            .eq("user_id", userId)
            .order("created_at", { ascending: false });

          if (error) {
            status.textContent = "Error loading favorites: " + error.message;
            return [];
          }

          const list = (data || []).map(row => ({
            slug: row.artist?.slug,
            name: row.artist?.name,
            country: row.artist?.country,
            region: row.artist?.region_sub,
            artist_id: row.artist_id
          }));

          const ids = list.map(l => l.artist_id).filter(Boolean);
          const profileMap = {};
          if (ids.length) {
            const { data: pics, error: picErr } = await supa
              .from("v_artist_profile_image")
              .select("artist_id, profile_image_url")
              .in("artist_id", ids);
            if (!picErr) {
              (pics || []).forEach(p => {
                if (p.profile_image_url) profileMap[p.artist_id] = p.profile_image_url;
              });
            } else {
              console.warn("Profile image fetch error:", picErr.message);
            }
          }

          return list.map(item => ({ ...item, image_url: profileMap[item.artist_id] }));
        }

        const localFavs = loadFavoritesLocal();
        const ids = localFavs.map(f => f.id).filter(Boolean);
        if (!ids.length) return [];

        const { data: artists, error: artistErr } = await supa
          .from("artists")
          .select("id,name,slug,country,region_sub")
          .in("id", ids);

        if (artistErr) {
          status.textContent = "Error loading local favorites: " + artistErr.message;
          return [];
        }

        const artistMap = {};
        (artists || []).forEach(a => { artistMap[a.id] = a; });

        const profileMap = {};
        const { data: pics, error: picErr } = await supa
          .from("v_artist_profile_image")
          .select("artist_id, profile_image_url")
          .in("artist_id", ids);

        if (!picErr) {
          (pics || []).forEach(p => {
            if (p.profile_image_url) profileMap[p.artist_id] = p.profile_image_url;
          });
        } else {
          console.warn("Profile image fetch error:", picErr.message);
        }

        return localFavs
          .map(f => {
            const a = artistMap[f.id];
            if (!a) return null;
            return {
              slug: a.slug,
              name: a.name,
              country: a.country,
              region: a.region_sub,
              artist_id: a.id,
              image_url: profileMap[a.id]
            };
          })
          .filter(Boolean);
      }

      async function removeFavorite(artistId) {
        if (!artistId) return;

        if (mode === "account" && userId) {
          const { error } = await supa
            .from("favorites")
            .delete()
            .eq("user_id", userId)
            .eq("artist_id", artistId);
          if (error) console.error("Remove favorite error:", error.message);
        } else {
          const localFavs = loadFavoritesLocal();
          const updated = localFavs.filter(f => f.id !== artistId);
          saveFavoritesLocal(updated);
        }
      }

      async function clearAll() {
        if (mode === "account" && userId) {
          const { error } = await supa
            .from("favorites")
            .delete()
            .eq("user_id", userId);
          if (error) {
            status.textContent = "Error clearing favorites: " + error.message;
            return;
          }
        } else {
          saveFavoritesLocal([]);
        }
      }

      function render(list) {
        grid.innerHTML = "";
        const count = list.length;

        clearBtn.disabled = count === 0;

        if (!count) {
          status.textContent = "No favorites yet. Go back and tap the star on any artist.";
          return;
        }

        status.textContent = `Showing ${count} favorites.`;

        list.forEach(fav => {
          const imgSrc = fav.image_url || "../sample_images/sample_img.png";
          const card = document.createElement("div");
          card.className = "artist-card";
          card.innerHTML = `
            <a class="card-link" href="../artist_page/artist_page.html?slug=${encodeURIComponent(fav.slug || "")}">
              <div class="art-image">
                <img src="${imgSrc}" alt="${fav.name || 'Artwork'}" loading="lazy" />
              </div>
              <div class="artist-info">
                <h3>${fav.name || 'Untitled'}</h3>
                ${fav.country ? `<p>${fav.country}${fav.region ? " — " + fav.region : ""}</p>` : ""}
              </div>
            </a>

            <!-- ✅ back on artwork area (absolute overlay) -->
            <button class="fav-btn" type="button"
              aria-label="Remove ${fav.name || 'artist'} from favorites"
              data-active="true">×</button>
          `;

          card.querySelector(".fav-btn").addEventListener("click", async (e) => {
            e.preventDefault();
            e.stopPropagation();
            await removeFavorite(fav.artist_id);
            const updated = await loadFavorites();
            render(updated);
          });

          grid.appendChild(card);
        });
      }

      clearBtn?.addEventListener("click", async () => {
        await clearAll();
        const updated = await loadFavorites();
        render(updated);
      });

      userId = await detectSessionUser();
      mode = userId ? "account" : "local";

      const list = await loadFavorites();
      render(list);
    })();
  </script>
</body>
</html>
