<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Admin â€” Art Platform</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="preconnect" href="https://cdn.jsdelivr.net" />
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  :root {
    --gap: 12px;
    --bg: #070708;
    --panel: #111214;
    --ink: #f2c34a;
    --muted: #c99b33;
    --line: #151518;
  }
  body {
    font-family: "Inter", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    margin: 24px auto;
    max-width: 1100px;
    padding: 0 16px 32px;
    color: var(--ink);
    background: var(--bg);
  }
  h1, h2 { margin: 0 0 8px; color: var(--ink); }
  header { display:flex; align-items:center; justify-content:space-between; margin-bottom: 8px; }
  section {
    margin: 24px 0;
    padding: 16px;
    border: 1px solid var(--line);
    border-radius: 12px;
    background: var(--panel);
    box-shadow: 0 14px 36px rgba(0,0,0,.45);
  }
  form { display:grid; gap: var(--gap); }
  .row { display:grid; grid-template-columns: 1fr 1fr; gap: var(--gap); }
  .row3 { display:grid; grid-template-columns: 1fr 1fr 1fr; gap: var(--gap); }
  input, select, textarea, button {
    padding:10px;
    font-size:14px;
    background: #0b0c0e;
    border:1px solid var(--line);
    color: var(--ink);
  }
  button { cursor:pointer; transition: filter .15s ease, transform .05s ease; }
  button:hover { filter: brightness(1.08); }
  button:active { transform: translateY(1px); }
  .muted { color:var(--muted); font-size: 12px; }
  .success { color: var(--ink); }
  .error { color:#b80606; }
  .stack { display:flex; gap:10px; align-items:center; flex-wrap: wrap; }
  img.preview { width:88px; height:88px; object-fit:contain; border-radius:8px; border:1px solid var(--line); background:#000; }
  table { width:100%; border-collapse:collapse; margin-top:10px; color: inherit; }
  th, td { padding:8px; border-bottom:1px solid var(--line); text-align:left; }
  td.actions { width: 220px; }
  .btn-secondary { background:#0f1012; border:1px solid #2a2b30; color: var(--muted); }
  .btn-danger { background:#140505; border:1px solid #b80606; color: var(--ink); }
  .pill { padding:3px 8px; border-radius:999px; font-size:12px; border:1px solid var(--line); background:#0b0c0e; color: var(--muted); }
</style>
</head>
<body>

<!-- 0) KEYS -->
<script>
  window.SUPABASE_URL = 'https://jhzlxmomyypgtkuwdvzn.supabase.co';
  window.SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impoemx4bW9teXlwZ3RrdXdkdnpuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgzOTgzMzEsImV4cCI6MjA3Mzk3NDMzMX0.IZw6mlxn7Hbue5UlrckhPJeCDNplj-zM1zoiddQGnj0';
  window.ARTWORKS_BUCKET = 'artworks';
</script>

<!-- ðŸ”’ Admin-only gate -->
<script type="module">
  import { requireAdmin } from "../_auth/auth-guard.js";
  (async () => {
    const s = await requireAdmin({
      redirectIfNoSession: "./admin.html",
      redirectIfNotAdmin: "../search_page/search_bar.html"
    });
    if (!s) return; // redirected if not admin
    const who = document.getElementById("whoami");
    if (who) who.textContent = s.user.email || s.user.id;
  })();
</script>

<header>
  <h1>Admin</h1>
  <div class="stack">
    <span class="muted">Signed in as <b id="whoami"></b></span>
    <button id="signOut" class="btn-secondary">Sign out</button>
  </div>
</header>
<p class="muted">Create, edit, and delete artists & artworks. (No avatar/hero images.)</p>

<!-- 2) CREATE / UPDATE ARTIST -->
<section>
  <div class="stack" style="justify-content:space-between">
    <h2>Create / Update Artist</h2>
    <span id="artistMode" class="pill">Mode: Create</span>
  </div>
  <form id="artistForm">
    <input type="hidden" id="artistId" />
    <div class="row">
      <input id="artistName" placeholder="Name" required />
      <input id="artistSlug" placeholder="Slug (optional; auto from name)" />
    </div>
    <textarea id="artistBio" rows="4" placeholder="Bio"></textarea>

    <div class="row3">
      <select id="artistGender">
        <option value="">Gender</option>
        <option value="male">Male</option><option value="female">Female</option>
        <option value="nonbinary">Non-binary</option><option value="other">Other</option>
        <option value="prefer_not_to_say">Prefer not to say</option>
      </select>

      <select id="artistRegion">
        <option value="">Region</option>
        <option>North Africa</option><option>West Africa</option><option>East Africa</option>
        <option>Central Africa</option><option>Southern Africa</option>
        <option>North America</option><option>Central America</option><option>Caribbean</option>
        <option>South America</option>
      </select>

      <select id="artistCountry" disabled>
        <option value="">Country</option>
      </select>
    </div>

    <!-- NEW: Medium / Style / Theme -->
    <div class="row3">
      <!-- Medium / Art Form -->
      <select id="artistMedium">
        <option value="">Medium / Art Form</option>
        <option value="Painting">Painting</option>
        <option value="Drawing / Illustration">Drawing / Illustration</option>
        <option value="Collage">Collage</option>
        <option value="Textile Art">Textile Art</option>
      </select>

      <!-- Style / Aesthetic -->
      <select id="artistStyle">
        <option value="">Style / Aesthetic</option>
        <option value="Abstract">Abstract</option>
        <option value="Figurative">Figurative</option>
        <option value="Minimalist">Minimalist</option>
        <option value="Surreal">Surreal</option>
        <option value="Expressionist">Expressionist</option>
        <option value="Conceptual">Conceptual</option>
        <option value="Realism">Realism</option>
        <option value="Pop Art">Pop Art</option>
        <option value="Contemporary">Contemporary</option>
        <option value="Street Art">Street Art</option>
        <option value="Futuristic">Futuristic</option>
        <option value="Organic / Nature-Inspired">Organic / Nature-Inspired</option>
        <option value="Geometric">Geometric</option>
        <option value="Portraiture">Portraiture</option>
        <option value="Landscape">Landscape</option>
      </select>

      <!-- Themes / Content -->
      <select id="artistTheme">
        <option value="">Themes / Content</option>
        <option value="Identity">Identity</option>
        <option value="Gender & Body">Gender &amp; Body</option>
        <option value="Spirituality">Spirituality</option>
        <option value="Politics & Society">Politics &amp; Society</option>
        <option value="Culture & Heritage">Culture &amp; Heritage</option>
        <option value="Urban Life">Urban Life</option>
        <option value="Nature & Environment">Nature &amp; Environment</option>
        <option value="Technology & AI">Technology &amp; AI</option>
        <option value="Emotion & Psychology">Emotion &amp; Psychology</option>
        <option value="Mythology & Symbolism">Mythology &amp; Symbolism</option>
        <option value="Migration & Memory">Migration &amp; Memory</option>
      </select>
    </div>

    <!-- NEW: Mood / Palette / Level / Format -->
    <div class="row3">
      <!-- Mood -->
      <select id="artistMood">
        <option value="">Mood</option>
        <option value="Calm">Calm</option>
        <option value="Vibrant">Vibrant</option>
        <option value="Dark">Dark</option>
        <option value="Dreamy">Dreamy</option>
        <option value="Energetic">Energetic</option>
        <option value="Intense">Intense</option>
        <option value="Soft">Soft</option>
        <option value="Bold">Bold</option>
      </select>

      <!-- Color Palette -->
      <select id="artistPalette">
        <option value="">Color Palette</option>
        <option value="Monochrome">Monochrome</option>
        <option value="Black & White">Black &amp; White</option>
        <option value="Warm Tones">Warm Tones</option>
        <option value="Cool Tones">Cool Tones</option>
        <option value="Earthy">Earthy</option>
        <option value="Pastel">Pastel</option>
        <option value="Bright / Multicolor">Bright / Multicolor</option>
      </select>

      <!-- Artist Level / Format share last slot (stack) -->
      <div class="stack" style="gap:8px; flex-wrap:nowrap;">
        <select id="artistLevel" style="flex:1;">
          <option value="">Artist Level</option>
          <option value="Emerging Artist">Emerging Artist</option>
          <option value="Mid-Career Artist">Mid-Career Artist</option>
          <option value="Established Artist">Established Artist</option>
          <option value="Student / Academy Artist">Student / Academy Artist</option>
        </select>

        <select id="artistFormat" style="flex:1;">
          <option value="">Format / Size</option>
          <option value="Small">Small</option>
          <option value="Medium">Medium</option>
          <option value="Large">Large</option>
          <option value="Extra Large">Extra Large</option>
        </select>
      </div>
    </div>

    <div class="stack">
      <button type="submit" id="artistSaveBtn">Save artist</button>
      <button type="button" id="artistCancelBtn" class="btn-secondary" style="display:none">Cancel edit</button>
      <span id="artistOut" class="muted"></span>
    </div>
  </form>

  <div id="artistsWrap">
    <h3 style="margin-top:16px">Existing artists</h3>

    <div class="stack" style="justify-content:space-between; margin-top:8px;">
      <input id="artistSearch" placeholder="Search artistsâ€¦" />
      <div class="stack">
        <button id="prevArtists" class="btn-secondary" type="button">Prev</button>
        <span id="artistPageLabel" class="muted">Page 1</span>
        <button id="nextArtists" class="btn-secondary" type="button">Next</button>
      </div>
    </div>

    <table id="artistsTable">
      <thead>
        <tr><th>Name</th><th>Slug</th><th>Region</th><th>Country</th><th class="actions">Actions</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</section>

<!-- 3) ARTWORKS -->
<section>
  <div class="stack" style="justify-content:space-between">
    <h2>Add / Edit Artwork</h2>
    <span id="artMode" class="pill">Mode: Create</span>
  </div>

  <div class="row">
    <select id="artistSelect">
      <option value="">Select artistâ€¦</option>
    </select>
    <button id="refreshArtists" type="button">Refresh list</button>
  </div>

  <form id="artForm" style="margin-top:12px">
    <input type="hidden" id="artId" />
    <div class="row">
      <input id="artTitle" placeholder="Title" required />
      <input id="artYear" type="number" placeholder="Year" />
    </div>
    <textarea id="artDesc" rows="3" placeholder="Description"></textarea>
    <div class="stack">
      <input type="file" id="artImage" accept="image/*" />
      <img id="artPreview" class="preview" style="display:none" />
    </div>
    <div class="stack">
      <button type="submit" id="artSaveBtn">Create artwork</button>
      <button type="button" id="artCancelBtn" class="btn-secondary" style="display:none">Cancel edit</button>
      <span id="artOut" class="muted"></span>
    </div>
  </form>

  <div id="artworksWrap">
    <h3 style="margin-top:16px">Existing artworks</h3>
    <table id="artworksTable">
      <thead>
        <tr>
          <th>Image</th><th>Title</th><th>Year</th><th>Description</th><th class="actions">Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</section>

<script>
  // ---------- Setup ----------  
  function pickAuthStorage() {
    try {
      const k = "sb-check";
      localStorage.setItem(k, "1");
      localStorage.removeItem(k);
      return localStorage;
    } catch (_) {}
    try {
      const k = "sb-check";
      sessionStorage.setItem(k, "1");
      sessionStorage.removeItem(k);
      return sessionStorage;
    } catch (_) {}
    return undefined;
  }

  const STORAGE_KEY = "sb-jhzlxmomyypgtkuwdvzn-auth-token";
  const supa = window.supabase.createClient(
    window.SUPABASE_URL,
    window.SUPABASE_ANON_KEY,
    { auth: { storageKey: STORAGE_KEY, storage: pickAuthStorage(), autoRefreshToken: true, persistSession: true, detectSessionInUrl: true } }
  );
  const ARTWORKS_BUCKET = window.ARTWORKS_BUCKET || 'artworks';

  async function ensureSessionOrRedirect() {
    const { data: { session } } = await supa.auth.getSession();
    if (!session?.user) {
      location.href = 'admin.html';
      return false;
    }
    const who = document.getElementById('whoami');
    if (who && !who.textContent) who.textContent = session.user.email || session.user.id;
    return true;
  }

  supa.auth.onAuthStateChange((event) => {
    if (event === 'SIGNED_OUT') location.href = 'admin.html';
  });

  document.getElementById('signOut').onclick = async () => { await supa.auth.signOut(); };

  function setStatus(el, msg, cls='muted'){ el.textContent = msg; el.className = cls; }
  function slugify(s){ return (s||'').toLowerCase().normalize('NFKD')
    .replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,''); }

  // Region data (same as search.js)
  const REGION_COUNTRIES = {
    "North Africa": ["Algeria","Egypt","Libya","Morocco","Sudan","Tunisia"],
    "West Africa": ["Benin","Burkina Faso","Cabo Verde","CÃ´te dâ€™Ivoire","Gambia","Ghana","Guinea","Guinea-Bissau","Liberia","Mali","Mauritania","Niger","Nigeria","Senegal","Sierra Leone","Togo"],
    "East Africa": ["Burundi","Comoros","Djibouti","Eritrea","Ethiopia","Kenya","Madagascar","Malawi","Mauritius","Mozambique","Rwanda","Seychelles","Somalia","South Sudan","Tanzania","Uganda"],
    "Central Africa": ["Angola","Cameroon","Central African Republic","Chad","Congo","Democratic Republic of the Congo","Equatorial Guinea","Gabon","SÃ£o TomÃ© and PrÃ­ncipe"],
    "Southern Africa": ["Botswana","Eswatini","Lesotho","Namibia","South Africa","Zambia","Zimbabwe"],
    "North America": ["Canada","United States","Mexico","Greenland"],
    "Central America": ["Belize","Costa Rica","El Salvador","Guatemala","Honduras","Nicaragua","Panama"],
    "Caribbean": ["Antigua and Barbuda","Bahamas","Barbados","Cuba","Dominica","Dominican Republic","Grenada","Haiti","Jamaica","Saint Kitts and Nevis","Saint Lucia","Saint Vincent and the Grenadines","Trinidad and Tobago"],
    "South America": ["Argentina","Bolivia","Brazil","Chile","Colombia","Ecuador","Guyana","Paraguay","Peru","Suriname","Uruguay","Venezuela"]
  };
  const REGION_ALIASES = {
    "north africa":"North Africa","west africa":"West Africa","east africa":"East Africa",
    "central africa":"Central Africa","southern africa":"Southern Africa",
    "north america":"North America","central america":"Central America",
    "caribbean":"Caribbean","carribean":"Caribbean"
  };
  function normalizeRegionLabel(label){
    if(!label) return "";
    const k = label.trim().toLowerCase();
    return REGION_ALIASES[k] || label.trim();
  }
  function resetCountrySelect(selectEl){
    selectEl.innerHTML = '<option value="">Country</option>';
    selectEl.disabled = true;
  }
  function populateCountries(regionLabel, selectEl){
    const region = normalizeRegionLabel(regionLabel);
    resetCountrySelect(selectEl);
    const list = REGION_COUNTRIES[region];
    if(!list) return;
    list.forEach(c => {
      const opt = document.createElement('option');
      opt.value = c;
      opt.textContent = c;
      selectEl.appendChild(opt);
    });
    selectEl.disabled = false;
  }
  function storageKeyFromPublicUrl(url){
    try{
      const marker = `/storage/v1/object/public/${ARTWORKS_BUCKET}/`;
      const idx = url.indexOf(marker);
      if(idx === -1) return null;
      return url.substring(idx + marker.length);
    }catch{ return null; }
  }
  async function requireAuth() {
    const { data: { session } } = await supa.auth.getSession();
    if (!session?.user) throw new Error('Not signed in.');
    return session.user;
  }

  // ---------- Artist UI refs ----------
  const artistForm = document.getElementById('artistForm');
  const artistOut  = document.getElementById('artistOut');
  const nameEl = document.getElementById('artistName');
  const slugEl = document.getElementById('artistSlug');
  const bioEl  = document.getElementById('artistBio');
  const genderEl = document.getElementById('artistGender');
  const regionEl = document.getElementById('artistRegion');
  const countryEl= document.getElementById('artistCountry');
  const artistIdEl = document.getElementById('artistId');
  const artistMode = document.getElementById('artistMode');
  const artistCancelBtn = document.getElementById('artistCancelBtn');
  const artistSaveBtn = document.getElementById('artistSaveBtn');
  const artistsTableBody = document.querySelector('#artistsTable tbody');

  // NEW: extended artist metadata
  const artistMediumEl  = document.getElementById('artistMedium');
  const artistStyleEl   = document.getElementById('artistStyle');
  const artistThemeEl   = document.getElementById('artistTheme');
  const artistMoodEl    = document.getElementById('artistMood');
  const artistPaletteEl = document.getElementById('artistPalette');
  const artistLevelEl   = document.getElementById('artistLevel');
  const artistFormatEl  = document.getElementById('artistFormat');

  const artistSearch = document.getElementById('artistSearch');
  const prevArtists = document.getElementById('prevArtists');
  const nextArtists = document.getElementById('nextArtists');
  const artistPageLabel = document.getElementById('artistPageLabel');
  let artistPage = 1;
  const artistPageSize = 20;
  let artistHasMore = false;

  regionEl.addEventListener('change', () => populateCountries(regionEl.value, countryEl));
  if (regionEl.value) populateCountries(regionEl.value, countryEl);

  function setArtistModeCreate(){
    artistIdEl.value = '';
    artistMode.textContent = 'Mode: Create';
    artistSaveBtn.textContent = 'Save artist';
    artistCancelBtn.style.display = 'none';
    setStatus(artistOut,'');
    artistForm.reset();
    resetCountrySelect(countryEl);
  }
  function setArtistModeEdit(row){
    artistIdEl.value = row.id;
    nameEl.value = row.name || '';
    slugEl.value = row.slug || '';
    bioEl.value = row.bio || '';
    genderEl.value = row.gender || '';
    regionEl.value = row.region_sub || '';
    populateCountries(regionEl.value, countryEl);
    countryEl.value = row.country || '';

    // NEW: fill extended metadata
    artistMediumEl.value  = row.medium || '';
    artistStyleEl.value   = row.style || '';
    artistThemeEl.value   = row.theme || '';
    artistMoodEl.value    = row.mood || '';
    artistPaletteEl.value = row.color_palette || '';
    artistLevelEl.value   = row.artist_level || '';
    artistFormatEl.value  = row.format_size || '';

    artistMode.textContent = 'Mode: Edit';
    artistSaveBtn.textContent = 'Update artist';
    artistCancelBtn.style.display = 'inline-block';
    setStatus(artistOut, `Editing artist id ${row.id}`, 'muted');
  }
  artistCancelBtn.onclick = () => setArtistModeCreate();

  artistForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const name = nameEl.value.trim();
    if (!name) return;
    const slug = (slugEl.value.trim() || slugify(name));

    try {
      artistSaveBtn.disabled = true;
      setStatus(artistOut, 'Checking authâ€¦');
      await requireAuth();

      const payload = {
        name,
        slug,
        bio: bioEl.value,
        gender: genderEl.value || null,
        region_sub: normalizeRegionLabel(regionEl.value) || null,
        country: countryEl.value || null,
        is_published: true,

        // NEW: extended metadata
        medium:        artistMediumEl.value  || null,
        style:         artistStyleEl.value   || null,
        theme:         artistThemeEl.value   || null,
        mood:          artistMoodEl.value    || null,
        color_palette: artistPaletteEl.value || null,
        artist_level:  artistLevelEl.value   || null,
        format_size:   artistFormatEl.value  || null
      };

      if(artistIdEl.value){
        setStatus(artistOut, 'Updating artist rowâ€¦');
        await supa.from('artists').update(payload).eq('id', artistIdEl.value).throwOnError();
        setStatus(artistOut, `Updated âœ”`, 'success');
      } else {
        setStatus(artistOut, 'Saving artist rowâ€¦');
        await supa.from('artists').upsert(payload, { onConflict: 'slug' }).throwOnError();
        setStatus(artistOut, `Saved âœ”`, 'success');
      }

      await loadArtistsList(artistPage);
      await loadArtistsIntoSelect();
      setArtistModeCreate();
    } catch (err) {
      setStatus(artistOut, 'Error: ' + (err?.message || err), 'error');
    } finally {
      artistSaveBtn.disabled = false;
    }
  });

  async function deleteArtist(id){
    try{
      await requireAuth();
      const { data: arts } = await supa.from('artworks').select('id').eq('artist_id', id).limit(1);
      if(arts && arts.length){
        const ok = confirm('This artist has artworks. If your DB is NOT set to ON DELETE CASCADE, delete will fail.\nProceed?');
        if(!ok) return;
      }
      await supa.from('artists').delete().eq('id', id).throwOnError();
      await loadArtistsList(1);
      await loadArtistsIntoSelect();
      if(artistIdEl.value === String(id)) setArtistModeCreate();
      alert('Artist deleted.');
    }catch(err){
      alert('Delete failed: ' + (err?.message || err));
    }
  }

  async function loadArtistsList(page = 1){
    const from = (page - 1) * artistPageSize;
    const to   = from + artistPageSize;
    let q = supa.from('artists')
      .select(
        'id,name,slug,region_sub,country,bio,gender,' +
        'medium,style,theme,mood,color_palette,artist_level,format_size',
        { count: 'exact' }
      )
      .eq('is_published', true);

    const term = (artistSearch.value || '').trim();
    if (term) q = q.or(`name.ilike.%${term}%,slug.ilike.%${term}%`);

    q = q.order('name', { ascending: true }).range(from, to);
    const { data, error, count } = await q;
    if (error) { console.error('loadArtistsList error:', error); return; }

    let rows = data || [];
    artistHasMore = rows.length > artistPageSize;
    if (artistHasMore) rows = rows.slice(0, artistPageSize);

    artistsTableBody.innerHTML = '';
    rows.forEach(a => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${a.name || ''}</td>
        <td>${a.slug || ''}</td>
        <td>${a.region_sub || ''}</td>
        <td>${a.country || ''}</td>
        <td class="actions">
          <button type="button" data-action="edit" class="btn-secondary" data-id="${a.id}">Edit</button>
          <button type="button" data-action="delete" class="btn-danger" data-id="${a.id}">Delete</button>
        </td>
      `;
      tr.querySelector('[data-action="edit"]').onclick = () => setArtistModeEdit(a);
      tr.querySelector('[data-action="delete"]').onclick = () => deleteArtist(a.id);
      artistsTableBody.appendChild(tr);
    });

    artistPage = page;
    artistPageLabel.textContent = `Page ${artistPage}${(typeof count === 'number') ? ` â€¢ ${count} total` : ''}`;
    prevArtists.disabled = artistPage === 1;
    nextArtists.disabled = !artistHasMore;
  }
  prevArtists.onclick = () => { if (artistPage > 1) loadArtistsList(artistPage - 1); };
  nextArtists.onclick = () => { if (artistHasMore) loadArtistsList(artistPage + 1); };
  artistSearch.addEventListener('input', () => loadArtistsList(1));

  // ---------- Artworks ----------
  const artistSelect = document.getElementById('artistSelect');
  const refreshArtistsBtn = document.getElementById('refreshArtists');
  const artForm = document.getElementById('artForm');
  const artTitle = document.getElementById('artTitle');
  const artYear  = document.getElementById('artYear');
  const artDesc  = document.getElementById('artDesc');
  const artImage = document.getElementById('artImage');
  const artPrev  = document.getElementById('artPreview');
  const artOut   = document.getElementById('artOut');
  const artIdEl  = document.getElementById('artId');
  const artMode  = document.getElementById('artMode');
  const artCancelBtn = document.getElementById('artCancelBtn');
  const artSaveBtn   = document.getElementById('artSaveBtn');
  const artworksTableBody = document.querySelector('#artworksTable tbody');

  artImage.addEventListener('change', () => {
    if (artImage.files[0]) {
      artPrev.src = URL.createObjectURL(artImage.files[0]);
      artPrev.style.display='block';
    }
  });

  function setArtModeCreate(){
    artIdEl.value = '';
    artMode.textContent = 'Mode: Create';
    artSaveBtn.textContent = 'Create artwork';
    artCancelBtn.style.display = 'none';
    artForm.reset(); artPrev.style.display='none';
    setStatus(artOut,'');
  }
  function setArtModeEdit(row){
    artIdEl.value = row.id;
    artTitle.value = row.title || '';
    artYear.value = row.year || '';
    artDesc.value = row.description || '';
    if(row.image_url){
      artPrev.src = row.image_url;
      artPrev.style.display='block';
    } else {
      artPrev.style.display='none';
    }
    artMode.textContent = 'Mode: Edit';
    artSaveBtn.textContent = 'Update artwork';
    artCancelBtn.style.display = 'inline-block';
    setStatus(artOut, `Editing artwork id ${row.id}`, 'muted');
  }
  artCancelBtn.onclick = () => setArtModeCreate();

  async function uploadArtworkImage(artistId, title, file){
    if(!file) return null;
    await requireAuth();
    const ts = Date.now();
    const key = `images/${artistId}/${ts}-${slugify(title)}`;
    const { error } = await supa.storage.from(ARTWORKS_BUCKET).upload(key, file, { upsert: true });
    if (error) throw error;
    return supa.storage.from(ARTWORKS_BUCKET).getPublicUrl(key).data.publicUrl;
  }
  async function removeArtworkImage(publicUrl){
    const key = storageKeyFromPublicUrl(publicUrl || '');
    if(!key) return;
    await supa.storage.from(ARTWORKS_BUCKET).remove([key]);
  }

  async function loadArtistsIntoSelect(){
    const { data, error } = await supa.from('artists')
      .select('id,name,slug')
      .eq('is_published', true)
      .order('name', { ascending: true });
    artistSelect.innerHTML = '<option value="">Select artistâ€¦</option>';
    if (error) { console.error('loadArtistsIntoSelect error:', error); return; }
    (data || []).forEach(a => {
      const opt = document.createElement('option');
      opt.value = a.id;
      opt.textContent = `${a.name} â€” ${a.slug}`;
      artistSelect.appendChild(opt);
    });
  }

  async function loadArtworksTable(artistId){
    artworksTableBody.innerHTML = '';
    if (!artistId) return;
    const { data, error } = await supa.from('artworks')
      .select('id,title,year,description,image_url,artist_id,is_profile')
      .eq('artist_id', artistId)
      .order('created_at', { ascending: false });
    if (error) { console.error('loadArtworksTable error:', error); return; }

    (data || []).forEach(a => {
      const tr = document.createElement('tr');
      const desc = a.description
        ? a.description.substring(0, 140) + (a.description.length > 140 ? 'â€¦' : '')
        : '';

      const profileBadge = a.is_profile
        ? '<span class="pill">Profile image</span> '
        : '';

      tr.innerHTML = `
        <td>
          ${a.image_url
            ? `<img src="${a.image_url}" style="width:60px;height:60px;object-fit:contain;border-radius:6px;border:1px solid #eee;background:#000" />`
            : ''}
        </td>
        <td>${a.title || ''}</td>
        <td>${a.year || ''}</td>
        <td>${desc}</td>
        <td class="actions">
          ${profileBadge}
          <button type="button" class="btn-secondary" data-action="profile" data-id="${a.id}">Set as profile</button>
          <button type="button" class="btn-secondary" data-action="edit" data-id="${a.id}">Edit</button>
          <button type="button" class="btn-danger" data-action="delete" data-id="${a.id}">Delete</button>
        </td>
      `;

      tr.querySelector('[data-action="profile"]').onclick = () => setProfileArtwork(a);
      tr.querySelector('[data-action="edit"]').onclick = () => setArtModeEdit(a);
      tr.querySelector('[data-action="delete"]').onclick = () => deleteArtwork(a);

      artworksTableBody.appendChild(tr);
    });
  }

  artistSelect.addEventListener('change', () => {
    setArtModeCreate();
    loadArtworksTable(artistSelect.value);
  });
  refreshArtistsBtn.addEventListener('click', async () => {
    await loadArtistsIntoSelect();
    if(artistSelect.value) await loadArtworksTable(artistSelect.value);
  });

  artForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const artistId = artistSelect.value;
    if (!artistId) {
      setStatus(artOut, 'Pick an artist first.', 'error');
      return;
    }
    const title = artTitle.value.trim();
    if (!title) {
      setStatus(artOut, 'Title is required.', 'error');
      return;
    }
    const year = parseInt(artYear.value || '0', 10) || null;

    try {
      artSaveBtn.disabled = true;
      setStatus(artOut, 'Checking authâ€¦');
      await requireAuth();

      const file = artImage.files[0];
      let image_url = null;

      if(artIdEl.value){
        const { data: existing } = await supa.from('artworks').select('image_url').eq('id', artIdEl.value).single();
        if(file){
          image_url = await uploadArtworkImage(artistId, title, file);
        }
        const updatePayload = {
          title,
          year,
          description: artDesc.value,
          is_published: true
        };
        if(image_url) updatePayload.image_url = image_url;

        await supa.from('artworks').update(updatePayload).eq('id', artIdEl.value).throwOnError();
        if(image_url && existing?.image_url){
          await removeArtworkImage(existing.image_url);
        }
        setStatus(artOut, `Artwork updated âœ”`, 'success');
      } else {
        if(file){
          image_url = await uploadArtworkImage(artistId, title, file);
        }
        await supa.from('artworks').insert([{
          artist_id: artistId,
          title,
          year,
          description: artDesc.value,
          image_url,
          is_published: true,
          is_profile: false
        }]).throwOnError();
        setStatus(artOut, `Artwork created âœ”`, 'success');
      }

      artForm.reset();
      artPrev.style.display='none';
      setArtModeCreate();
      loadArtworksTable(artistId);
    } catch (err) {
      setStatus(artOut, 'Error: ' + (err?.message || err), 'error');
    } finally {
      artSaveBtn.disabled = false;
    }
  });

  async function deleteArtwork(artRow){
    const ok = confirm(`Delete artwork "${artRow.title}"? This cannot be undone.`);
    if(!ok) return;
    try{
      await requireAuth();
      await supa.from('artworks').delete().eq('id', artRow.id).throwOnError();
      if(artRow.image_url){
        await removeArtworkImage(artRow.image_url);
      }
      if(artIdEl.value === String(artRow.id)) setArtModeCreate();
      await loadArtworksTable(artRow.artist_id);
      alert('Artwork deleted.');
    }catch(err){
      alert('Delete failed: ' + (err?.message || err));
    }
  }

  async function setProfileArtwork(artRow) {
    try {
      await requireAuth();

      // Clear current profile for this artist
      await supa
        .from('artworks')
        .update({ is_profile: false })
        .eq('artist_id', artRow.artist_id)
        .throwOnError();

      // Set this one as profile
      await supa
        .from('artworks')
        .update({ is_profile: true })
        .eq('id', artRow.id)
        .throwOnError();

      setStatus(artOut, `Set "${artRow.title}" as profile image âœ”`, 'success');
      await loadArtworksTable(artRow.artist_id);
    } catch (err) {
      console.error(err);
      setStatus(artOut, 'Error setting profile: ' + (err?.message || err), 'error');
    }
  }

  // ---------- Boot ----------
  (async function init(){
    const ok = await ensureSessionOrRedirect();
    if(!ok) return;
    regionEl.addEventListener('change', () => populateCountries(regionEl.value, countryEl));
    await loadArtistsList(1);
    await loadArtistsIntoSelect();
  })();
</script>
</body>
</html>
