<!-- public/artist_page/artist_page.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Artist</title>
  <link rel="stylesheet" href="artist_page.css" />

  <!-- Supabase keys (same as search/admin) -->
  <script>
    window.SUPABASE_URL = 'https://jhzlxmomyypgtkuwdvzn.supabase.co';
    window.SUPABASE_ANON_KEY =  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impoemx4bW9teXlwZ3RrdXdkdnpuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgzOTgzMzEsImV4cCI6MjA3Mzk3NDMzMX0.IZw6mlxn7Hbue5UlrckhPJeCDNplj-zM1zoiddQGnj0';
  </script>
  <!-- UMD build (NOT type="module") -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div class="artist_page-wrapper" id="artistRoot">
    <a href="../search_page/search_bar.html" class="back-btn" aria-label="Back to search page">‹</a>

    <header class="artist-header">
      <h1 id="artistName"></h1>
      <p id="artistMeta" class="artist-meta"></p>
    </header>

    <p id="artistBio" class="artist-bio"></p>

    <div class="gallery" aria-label="Artwork gallery">
      <div class="track" id="track"></div>
      <button type="button" class="nav prev" id="prev" aria-label="Previous slide">‹</button>
      <button type="button" class="nav next" id="next" aria-label="Next slide">›</button>
      <div class="dots" id="dots" aria-label="Slide pagination"></div>
    </div>

    <p id="artwork-desc" class="artwork-desc" aria-live="polite"></p>
  </div>

  <script>
    (async function () {
      const root = document.getElementById('artistRoot');
      const showError = (msg) => { root.innerHTML = `<p class="error">${msg}</p>`; };

      // 0) slug from URL
      const params = new URLSearchParams(location.search);
      const slug = params.get('slug');
      if (!slug) return showError('Missing artist slug in the URL.');

      if (!window.supabase) return showError('Supabase JS not loaded.');
      const supa = window.supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);

      // 1) Fetch the published artist by slug
      const { data: artist, error: artistErr } = await supa
        .from('artists')
        .select('id,name,slug,bio,country,region_sub,gender,is_published')
        .eq('slug', slug)
        .eq('is_published', true)
        .maybeSingle();

      if (artistErr) return showError('Error loading artist: ' + artistErr.message);
      if (!artist)   return showError('Artist not found or unpublished.');

      document.title = `${artist.name} — Artist`;
      document.getElementById('artistName').textContent = artist.name || '';
      document.getElementById('artistMeta').textContent =
        [artist.country, artist.region_sub, artist.gender].filter(Boolean).join(' • ');

      // 2) Fetch this artist's published artworks
      const { data: arts, error: artsErr } = await supa
        .from('artworks')
        .select('id,title,description,image_url,year,is_published,created_at')
        .eq('artist_id', artist.id)
        .eq('is_published', true)
        .order('created_at', { ascending: false });

      if (artsErr) console.warn('Artworks error:', artsErr.message);

      // 3) Render slides
      const track = document.getElementById('track');
      const makeFig = (a) => {
        const fig = document.createElement('figure');
        fig.className = 'slide';
        if (a.description) fig.dataset.desc = a.description;
        const safeTitle = a.title || 'Artwork';
        const cap = a.year ? `${safeTitle} (${a.year})` : safeTitle;
        fig.innerHTML = `
          <img src="${a.image_url || '../sample_images/sample_img.png'}" alt="${safeTitle}" loading="lazy" />
          <figcaption>${cap}</figcaption>
        `;
        return fig;
      };

      if (arts && arts.length) {
        arts.forEach(a => track.appendChild(makeFig(a)));
      } else {
        track.appendChild(makeFig({ title: 'No artworks yet', image_url: '../sample_images/sample_img.png' }));
      }

      // 4) Slider controls (CSS animates .track)
      const slides   = Array.from(track.children);
      const btnPrev  = document.getElementById('prev');
      const btnNext  = document.getElementById('next');
      const dotsWrap = document.getElementById('dots');
      const descEl   = document.getElementById('artwork-desc');

      let index = 0;
      let startX = 0, currentX = 0, isDragging = false;
      const threshold = 40;

      // dots
      dotsWrap.innerHTML = '';
      slides.forEach((_, i) => {
        const b = document.createElement('button');
        b.type = 'button';
        b.setAttribute('aria-label', 'Go to slide ' + (i + 1));
        b.addEventListener('click', () => goTo(i));
        dotsWrap.appendChild(b);
      });

      function update() {
        track.style.transform = `translateX(-${index * 100}%)`;
        Array.from(dotsWrap.children).forEach((b, i) =>
          b.setAttribute('aria-current', i === index ? 'true' : 'false')
        );
        btnPrev.disabled = (index === 0);
        btnNext.disabled = (index === slides.length - 1);

        const slide = slides[index];
        const fromData = slide.dataset.desc;
        const fromCaption = slide.querySelector('figcaption')?.textContent?.trim();
        descEl.textContent = fromData || fromCaption || '';
      }
      function goTo(i) { index = Math.max(0, Math.min(i, slides.length - 1)); update(); }

      const next = () => goTo(index + 1);
      const prev = () => goTo(index - 1);

      btnNext.addEventListener('click', next);
      btnPrev.addEventListener('click', prev);

      // keyboard
      document.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowRight') next();
        if (e.key === 'ArrowLeft')  prev();
      });

      // touch swipe
      track.addEventListener('touchstart', (e) => {
        isDragging = true;
        startX = e.touches[0].clientX;
        currentX = startX;
        track.style.transition = 'none';
      }, { passive: true });

      track.addEventListener('touchmove', (e) => {
        if (!isDragging) return;
        currentX = e.touches[0].clientX;
        const dx = currentX - startX;
        const percent = (dx / track.clientWidth) * 100;
        const base = -index * 100;
        track.style.transform = `translateX(${base + percent}%)`;
      }, { passive: true });

      function endSwipe() {
        if (!isDragging) return;
        isDragging = false;
        track.style.transition = ''; // let CSS handle it
        const dx = currentX - startX;
        if (dx > threshold) prev();
        else if (dx < -threshold) next();
        else update();
      }
      track.addEventListener('touchend', endSwipe, { passive: true });
      track.addEventListener('touchcancel', endSwipe, { passive: true });

      // init
      update();
    })();
  </script>
</body>
</html>

