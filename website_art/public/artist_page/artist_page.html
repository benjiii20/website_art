<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Artist</title>

  <!-- NOIR fonts -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="artist_page.css" />

  <!-- Supabase keys (same as search/admin) -->
  <script>
    window.SUPABASE_URL = 'https://jhzlxmomyypgtkuwdvzn.supabase.co';
    window.SUPABASE_ANON_KEY =  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impoemx4bW9teXlwZ3RrdXdkdnpuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgzOTgzMzEsImV4cCI6MjA3Mzk3NDMzMX0.IZw6mlxn7Hbue5UlrckhPJeCDNplj-zM1zoiddQGnj0';
  </script>
  <!-- UMD build (NOT type="module") -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div class="artist_page-wrapper" id="artistRoot">
    <a href="../search_page/search_bar.html" class="back-btn" aria-label="Back to search page">‹</a>

    <header class="artist-header">
      <div class="artist-header-main">
        <h1 class="artist-title">
          <a id="artistLink" class="artist-title-link" href="#" aria-label="Open artist bio">
            <span id="artistName"></span>
          </a>
        </h1>
        <p id="artistMeta" class="artist-meta"></p>
      </div>

      <!-- Favorites button in the header -->
      <button
        id="favoriteBtn"
        class="artist-fav-btn"
        type="button"
        aria-pressed="false"
        title="Add to favorites"
      >
        ☆
      </button>
    </header>

    <!-- bio removed -->

    <div class="gallery" aria-label="Artwork gallery">
      <div class="track" id="track"></div>
      <button type="button" class="nav prev" id="prev" aria-label="Previous slide">‹</button>
      <button type="button" class="nav next" id="next" aria-label="Next slide">›</button>
      <div class="dots" id="dots" aria-label="Slide pagination"></div>
    </div>

    <div class="preview-overlay" id="previewOverlay" role="dialog" aria-modal="true" aria-label="Artwork preview">
      <img id="previewImage" alt="Artwork preview" />
    </div>

    <p id="artwork-desc" class="artwork-desc" aria-live="polite"></p>
  </div>

  <script>
    (async function () {
      const root = document.getElementById('artistRoot');
      const showError = (msg) => { root.innerHTML = `<p class="error">${msg}</p>`; };

      // Local favorites cache key (for logged-out users)
      const FAVORITES_KEY = "favorite_artists";
      const loadFavoritesLocal = () => {
        try { return JSON.parse(localStorage.getItem(FAVORITES_KEY)) || []; }
        catch { return []; }
      };
      const saveFavoritesLocal = (list) => {
        localStorage.setItem(FAVORITES_KEY, JSON.stringify(list));
      };

      // 0) slug from URL
      const params = new URLSearchParams(location.search);
      const slug = params.get('slug');
      if (!slug) return showError('Missing artist slug in the URL.');

      if (!window.supabase) return showError('Supabase JS not loaded.');
      const supa = window.supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);

      // 1) Fetch the published artist by slug
      const { data: artist, error: artistErr } = await supa
        .from('artists')
        .select('id,name,slug,bio,country,region_sub,gender,is_published')
        .eq('slug', slug)
        .eq('is_published', true)
        .maybeSingle();

      if (artistErr) return showError('Error loading artist: ' + artistErr.message);
      if (!artist)   return showError('Artist not found or unpublished.');

      document.title = `${artist.name} — Artist`;
      document.getElementById('artistName').textContent = artist.name || '';
      document.getElementById('artistMeta').textContent =
        [artist.country, artist.region_sub, artist.gender].filter(Boolean).join(' • ');

      const artistLink = document.getElementById('artistLink');
      artistLink.href = `../biopage/biopage.html?slug=${encodeURIComponent(artist.slug)}`;
      artistLink.setAttribute('aria-label', `Open bio for ${artist.name}`);

      // === favorites on artist page ===
      const favBtn = document.getElementById('favoriteBtn');
      let isFavorite = false;
      let currentUserId = null;

      function syncFavButton() {
        if (!favBtn) return;
        favBtn.dataset.active = isFavorite ? "true" : "false";
        favBtn.textContent = isFavorite ? "★" : "☆";
        favBtn.setAttribute("aria-pressed", isFavorite ? "true" : "false");
        favBtn.title = isFavorite ? "Remove from favorites" : "Add to favorites";
      }

      async function initFavorite() {
        if (!favBtn) return;

        // Get auth session (if any)
        try {
          const { data: { session } } = await supa.auth.getSession();
          if (session?.user) currentUserId = session.user.id;
        } catch (err) {
          console.warn("Auth session error:", err);
        }

        // Check if this artist is already a favorite
        if (currentUserId) {
          const { data, error } = await supa
            .from("favorites")
            .select("artist_id")
            .eq("user_id", currentUserId)
            .eq("artist_id", artist.id)
            .maybeSingle();

          if (!error && data?.artist_id) {
            isFavorite = true;
          }
        } else {
          // Fallback: local only
          const local = loadFavoritesLocal();
          isFavorite = local.some((f) => f.id === artist.id);
        }

        syncFavButton();

        favBtn.addEventListener("click", async () => {
          // If logged in, persist to Supabase
          if (currentUserId) {
            if (isFavorite) {
              const { error } = await supa
                .from("favorites")
                .delete()
                .eq("user_id", currentUserId)
                .eq("artist_id", artist.id);
              if (!error) isFavorite = false;
            } else {
              const { error } = await supa
                .from("favorites")
                .insert({ user_id: currentUserId, artist_id: artist.id });
              if (!error) isFavorite = true;
            }
          } else {
            // No auth: store favorites locally so UI still works
            const local = loadFavoritesLocal();
            if (isFavorite) {
              const updated = local.filter((f) => f.id !== artist.id);
              saveFavoritesLocal(updated);
              isFavorite = false;
            } else {
              const updated = [
                ...local.filter((f) => f.id !== artist.id),
                { id: artist.id }
              ];
              saveFavoritesLocal(updated);
              isFavorite = true;
            }
          }

          syncFavButton();
        });
      }

      await initFavorite();

      // 2) Fetch this artist's published artworks
      const { data: arts, error: artsErr } = await supa
        .from('artworks')
        .select('id,title,description,image_url,year,is_published,created_at')
        .eq('artist_id', artist.id)
        .eq('is_published', true)
        .order('created_at', { ascending: false });

      if (artsErr) console.warn('Artworks error:', artsErr.message);

      // 3) Render slides
      const track = document.getElementById('track');
      const previewOverlay = document.getElementById('previewOverlay');
      const previewImage   = document.getElementById('previewImage');

      const makeFig = (a) => {
        const fig = document.createElement('figure');
        fig.className = 'slide';
        if (a.description) fig.dataset.desc = a.description;
        const safeTitle = a.title || 'Artwork';
        const cap = a.year ? `${safeTitle} (${a.year})` : safeTitle;
        fig.innerHTML = `
          <img src="${a.image_url || '../sample_images/sample_img.png'}" alt="${safeTitle}" loading="lazy" />
          <figcaption>${cap}</figcaption>
        `;
        return fig;
      };

      if (arts && arts.length) {
        arts.forEach(a => track.appendChild(makeFig(a)));
      } else {
        track.appendChild(makeFig({ title: 'No artworks yet', image_url: '../sample_images/sample_img.png' }));
      }

      // 4) Slider controls
      const slides   = Array.from(track.children);
      const btnPrev  = document.getElementById('prev');
      const btnNext  = document.getElementById('next');
      const dotsWrap = document.getElementById('dots');
      const descEl   = document.getElementById('artwork-desc');

      let index = 0;
      let startX = 0, currentX = 0, isDragging = false;
      const threshold = 40;

      // dots
      dotsWrap.innerHTML = '';
      slides.forEach((_, i) => {
        const b = document.createElement('button');
        b.type = 'button';
        b.setAttribute('aria-label', 'Go to slide ' + (i + 1));
        b.addEventListener('click', () => goTo(i));
        dotsWrap.appendChild(b);
      });

      function update() {
        track.style.transform = `translateX(-${index * 100}%)`;
        Array.from(dotsWrap.children).forEach((b, i) =>
          b.setAttribute('aria-current', i === index ? 'true' : 'false')
        );
        btnPrev.disabled = (index === 0);
        btnNext.disabled = (index === slides.length - 1);

        const slide = slides[index];
        const fromData = slide.dataset.desc;
        const fromCaption = slide.querySelector('figcaption')?.textContent?.trim();
        descEl.textContent = fromData || fromCaption || '';
      }
      function goTo(i) { index = Math.max(0, Math.min(i, slides.length - 1)); update(); }

      const next = () => goTo(index + 1);
      const prev = () => goTo(index - 1);

      btnNext.addEventListener('click', next);
      btnPrev.addEventListener('click', prev);

      // keyboard
      document.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowRight') next();
        if (e.key === 'ArrowLeft')  prev();
      });

      // touch swipe
      track.addEventListener('touchstart', (e) => {
        isDragging = true;
        startX = e.touches[0].clientX;
        currentX = startX;
        track.style.transition = 'none';
      }, { passive: true });

      track.addEventListener('touchmove', (e) => {
        if (!isDragging) return;
        currentX = e.touches[0].clientX;
        const dx = currentX - startX;
        const percent = (dx / track.clientWidth) * 100;
        const base = -index * 100;
        track.style.transform = `translateX(${base + percent}%)`;
      }, { passive: true });

      function endSwipe() {
        if (!isDragging) return;
        isDragging = false;
        track.style.transition = '';
        const dx = currentX - startX;
        if (dx > threshold) prev();
        else if (dx < -threshold) next();
        else update();
      }
      track.addEventListener('touchend', endSwipe, { passive: true });
      track.addEventListener('touchcancel', endSwipe, { passive: true });

      // Preview lightbox
      function openPreview() {
        const slide = slides[index];
        const img = slide.querySelector('img');
        if (!img) return;
        previewImage.src = img.src;
        previewImage.alt = img.alt || 'Artwork preview';
        previewOverlay.classList.add('open');
        document.body.style.overflow = 'hidden';
      }
      function closePreview() {
        previewOverlay.classList.remove('open');
        document.body.style.overflow = '';
      }
      document.querySelector('.gallery').addEventListener('click', (e) => {
        const controlClicked = e.target.closest('.nav') || e.target.closest('.dots');
        if (controlClicked) return; // avoid opening when using controls
        openPreview();
      });
      previewOverlay.addEventListener('click', closePreview);

      // init
      update();
    })();
  </script>
</body>
</html>
